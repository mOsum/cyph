<!DOCTYPE html>
<html manifest='websign/appcache.appcache'>
	<head>
		<meta charset='utf-8' />
		<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1' />
		<meta name='google' content='notranslate' />
		<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
		<meta name='apple-mobile-web-app-capable' content='yes' />
		<meta name='mobile-web-app-capable' content='yes' />
		<meta name='referrer' content='no-referrer' />
		<link rel='manifest' href='websign/manifest.json' />

		<title>Cyph &ndash; Encrypted Messenger</title>
		<meta
			name='description'
			content='Cyph secures your conversations against any threat, from lone hackers, to agencies armed with theoretical quantum attacks — no signup or downloads required. Cyph your friends. Reclaim your privacy.'
		/>
		<meta property='og:title' content='Cyph &ndash; Encrypted Messenger' />
		<meta
			property='og:description'
			content='Cyph secures your conversations against any threat, from lone hackers, to agencies armed with theoretical quantum attacks — no signup or downloads required. Cyph your friends. Reclaim your privacy.'
		/>
		<meta property='og:image' content='https://www.cyph.com/img/metaimage.png' />
		<meta property='og:url' content='https://$PROJECT' />
		<meta property='og:type' content='website' />

		<link rel='icon' sizes='192x192' type='image/png' href='/img/favicon/favicon-192x192.png' />
		<link rel='icon' sizes='160x160' type='image/png' href='/img/favicon/favicon-160x160.png' />
		<link rel='icon' sizes='96x96' type='image/png' href='/img/favicon/favicon-96x96.png' />
		<link rel='icon' sizes='32x32' type='image/png' href='/img/favicon/favicon-32x32.png' />
		<link rel='icon' sizes='16x16' type='image/png' href='/img/favicon/favicon-16x16.png' />
		<link rel='apple-touch-icon' sizes='180x180' type='image/png' href='/img/favicon/apple-touch-icon-180x180.png' />
		<link rel='apple-touch-icon' sizes='152x152' type='image/png' href='/img/favicon/apple-touch-icon-152x152.png' />
		<link rel='apple-touch-icon' sizes='144x144' type='image/png' href='/img/favicon/apple-touch-icon-144x144.png' />
		<link rel='apple-touch-icon' sizes='120x120' type='image/png' href='/img/favicon/apple-touch-icon-120x120.png' />
		<link rel='apple-touch-icon' sizes='114x114' type='image/png' href='/img/favicon/apple-touch-icon-114x114.png' />
		<link rel='apple-touch-icon' sizes='76x76' type='image/png' href='/img/favicon/apple-touch-icon-76x76.png' />
		<link rel='apple-touch-icon' sizes='72x72' type='image/png' href='/img/favicon/apple-touch-icon-72x72.png' />
		<link rel='apple-touch-icon' sizes='60x60' type='image/png' href='/img/favicon/apple-touch-icon-60x60.png' />
		<link rel='apple-touch-icon' sizes='57x57' type='image/png' href='/img/favicon/apple-touch-icon-57x57.png' />
		<meta name='msapplication-TileImage' content='/img/favicon/mstile-144x144.png' />
		<meta name='msapplication-TileColor' content='#8b62d9' />
		<meta name='theme-color' content='#8b62d9' />

		<link rel='stylesheet' href='websign/css/websign.css' />
	</head>
	<body>
		<div id='pre-load'>
			<div class='double-bounce1'></div>
			<div class='double-bounce2'></div>

			<div id='pre-load-message' class='message'>
				<p>
					Validating application integrity...
				</p>
				<p>
					Please wait; this may take a few seconds.
				</p>
			</div>

			<div id='panic-message' class='message' style='display: none'>
				<div>
					<h3>
						<strong>WARNING:</strong>
						Validation Failed
					</h3>
					<div class='left'>
						<p>
							Common reasons for this:
						</p>
						<ol>
							<li>
								You're using a non-Safari browser on iOS, such as Chrome.
								Chrome on iOS tampers with page content.
								<br />
								<strong>Fix:</strong>
								Use Cyph in Safari on iOS.
							</li>
							<li>
								Your antivirus software intercepts and tampers with Internet connections.
								<br />
								<strong>Fix:</strong>
								This function poses numerous security risks. Disable it.
							</li>
						</ol>
					</div>
					<p>
						If neither of these apply to you,
						<strong>DO NOT refresh this page or otherwise continue to use Cyph.</strong>
						<br />
						To reduce possible risk from malware, cease using this device entirely and
						<strong><a
							href='mailto:%22Ryan%20and%20Josh%22%20%3Cwebsign@cyph.com%3E?subject=I%20RECEIVED%20THE%20WEBSIGN%20WARNING&body=Hello%20Ryan%20and%20Josh%2C%0A%0A'
						>email us immediately.</a></strong>
						We will investigate and advise on how to proceed.
						<strong>
							DO NOT trust any reply that isn't signed using
							<a
								target='_blank'
								href='data:text/plain;base64,LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tClZlcnNpb246IEdudVBHIHYxCkNvbW1lbnQ6IEtleSBJRCAweDM5NUQ5QzA3RTQyNEFBMDAKCm1RSU5CRmFhbHQ4QkVBQys0bHJPazExZWdja3NZRHlyYkhKMXlLNmdOTzVobHYzb1k0ZjVNOW9samhZU2xmdmoKZmJBcy9QT0dvWUtmaFZLUS9rWkx2WlcvL0QveThTUHNrUlNzZmNmUlZHdzc0MVVtdFNFQjZhQll6cExBMUJzSAprZGZQaEFGME95eFFUcGZzaVVad2plYUhLYUo2TFc0NXY2NzZuZWtzWXVUa2J1bTVMYUxacTVOSWovZUpKOVZyCnFyN0pCNm1idm1naHJIN1lQeXRNdnNUdzlVNlMzNDNucVg3QmJTTjJ1Sit1d0g0cTRRNHdzOURCc0Z5eUNaWkcKNXRlZnVTVjJrU0JGT0hmekxmQmJFanlObzRndXZ1aE5KZndUZlI3VnZwM2RkTVVFTVJLT1I1ckpnbGNKZmtLegphdWZMZXhGUkdDY0hJNm9tTGQ4Vnc1K0gxTWRSdDI2eE5qRUNxdHR3UnpzS1pVZ2JBNGlRYnRQNUdnNkRkbTdSCjhCWTBNWE9BdHNSYjB2REM2YnIzblpEV3l3dVhJaEJObHhUL2FxNkhXSXVFd0JxVXdXdkRhdW0vZnRkK3lHaG4KN3dJZFJUeW9DMnE1SXFPbTVLa3M5M2ZYZWtXa1BXWGhPeU9DeHpVdjhzMHJsV2Q4TUpidUppRGhEN2dESlBDRAo3MnAra3AzaWVzVmxaU3Ezb2dGN1BySlJuUThncS84RGx1Q0lYK1JkcGpmK1dkZWVxcjlOK21KK01tWWdCaVZYClBua0E0RGlLTG1Dc3A1UDJKRThqSWZmbDZDbWs4Rm50bTQzcUFpNFpkd0tkZFhQOWowSXI5ek5lWCtsM2R4UmIKMVhNM0xaYTBVMzM4T080cEo0aU1NVVo2VDM1OWwveDJMcTkvQlYvZmx4ay9MSVFndE9HRXluRTlrd0FSQVFBQgp0RVpTZVdGdUlFeGxjM1JsY2lBbUlFSmhjbTl1SUVwdmMyaDFZU0JEZVhKMWN5QkNiMlZvYlNBb1EzbHdhQ3dnClNXNWpMaWtnUEhkbFluTnBaMjVBWTNsd2FDNWpiMjAraVFJNEJCTUJBZ0FpQlFKV21wYmZBaHNEQmdzSkNBY0QKQWdZVkNBSUpDZ3NFRmdJREFRSWVBUUlYZ0FBS0NSQTVYWndINUNTcUFLcTlELzR3TGpiMExNU2ZxdEJUOTZFTgpMaVJNTXZVRHIzSXFWT0Jrb0JVRmNmMUtDcVhFMXlyYk5lcjlRc2hYeWdmMC9UUDgvUHIwTWZ0aEQzQ01lcGNvCmVPOHNwRGc2d2ZsLzhhVjE4MGdKZlBwL1pxUytJNHVUYzBRVUVLa2YySmZVSzNteUdmcUJWQ1o2bkRaYnRQVlcKN1pESHVZUmxBa3JhTVp3K2ZvN1l5QmlvNFJnbXg3TSs2ZmpxL3BXbmxST0NQbUNsZnhTQkpLRDN2QjFubFdPeQpuYlVlQnMxVEMrSVUyNkpIeXNRS2R1SFJCbUorUThDRzk5cWkybk9lTHNvd3A1bzhEVEdkdG8yNEpaZ0FneXJZClFsaDY3UHdIcXpMUEJCTjE2RFNzcTJjRGdKS2J4R09wY2h0Q0owSW9KK3daa3ZCeTQ0bEEvVVNyUFlNRHp4N1gKSmhzVGgxZDZxRDUwRUluRjFKeXpHUWRLOFIzclFJOHJJd1hmNTlPOGVLd0Jrd25RNzdBdWxQZTBSTVB6VDVWSwpHU3FabDlWdXc1OUxoOTlHT1QybkV0K05XUWY4RjlYcmdSeWRiSERjUjRueVB6am1kdHlpcGdVSFRPK0hCRGZICnZOTlFTVmllYnA0ZGhLRXczbjhvbzQwN0Z6SVFnVkp4T0V6SmtpdHRyV0dsei9vdnFmS05KNU9HUjVKcjRvSmQKZEZVNzZnTjdpeGFlS0l1SGdqTmIyOXJjcXE1WWVSZWJRcnFUN1RDTjNQNXdlakVzZmhVWFBkQUp2WmMzU29ESwpIMGZWTEpKY1pveTJXQTQxclZaTmh3NG80cGF0a3JSczlZaFh3bngvVXRtVmI0WGlGVmhMQnNDOGErYWFSNUxmCi9HdnpUV01IOHdFQzEzcWt4R1NJNmk5Sng3a0NEUVJXbXBiZkFSQUFxZkpTSEYwdnlEdWVkeUZVNzNtVEtjRzEKOGtCWEc0NXhGeEY5YUptRmtSUndiVnJlYUdnVlJ1b0FraGRaYldEbnNrQWpib2hEWGpCQjBhb3BzTmVPYkxqTQoxL3NQeVlQZzdQYnV4RldrUkpyV3lDUFZVcytINmRUbXBFaFZaRTFkNDh4Zlp3Y2I3cDNEMU5MOUJzN2JSYWhiCndCTW5jT1ZkLzNtQS9OdWpFdXhzMGtmbjV6V1JFK1owN2hCVHFlL21sK3FGYmR5a25tY0Z5R2lOSlVUQ0s1dWsKWXlvViswVHZsWHA3cTloZEFDYWRMdGE4dDB2QlNxTC8vVnNUTk1NR25kKzNGdnJrNnZKY3EvRHBLc3U4enpKZApxbzBGZkE0cjhQM294bWJZR0xHRi9USHdyaVVYcGJkQWl6UXNmMW5ESEtZNm9ma0Q4amhiYmE3RVBqWjU2a1JNCnFESzF6Q1hxMmE4eTJ5bDhNV0FacnRvQmI5dHlaRXp3aXJ6cDJYMHR5WUFIQnZEd29QeTdRRFEvM1F1RTdqVloKUmc3Y0RWNTQ4QzRZUldmZlYyRW5xRVlxZEQwZ1NEbGhBdFlZUFcyUnVyUGJXd0xYb3A5YXdIZG9uYXJFdUhENwpwVTVSSzUyTGlNdnZkdjlBMnRyWjdEWVA5azlReW9UQStCZ3N5NzZKTkFJMWNLWGk5ejZxeUJLRmY2TjVGR25oCmZ4anNDZm9zOUtZRXdOYUxDdzBTbEs3VVFlRkNQMlNDeXJ5VExkRmN4RTB5b0tRQXVOL0NBN3ZzQk5RcDNBWDUKU21lNWl2cXVoT1hlcmk1cWhEMTBvWmZGTk9DWTJqQkVFRFVabGpHTTl3YjliazRqemhEY3Q1RG1pcmpMemtKQgoyVEpGVG9pYUNDTVg5cFhlaFlrQUVRRUFBWWtDSHdRWUFRSUFDUVVDVnBxVzN3SWJEQUFLQ1JBNVhad0g1Q1NxCkFPQnJEL3dJRVdWVzhPSm83ZHRuc0M0Mlg0UDBzMHZRaW1ldkIvbHBkblErbWpoYnFuTjI5QUExOURDVXN3Z1IKUyt5UDdsQSttTHc2clNQZzBmbUJsMUx4R0tHR2pYbzlCY0pWd2ZFZ3cxS1NlcTdDRnpPRURMbmJ3TFROcmpycwpqY1IvSFhHY1Y2QnBJbnZvZEE3STJXK2pOd0JJSitYTWhBMkhjY1NUdlNlbnllVGIxa0YrQVBQNnNiL0JwM3VECnVucjN3dzRqM05HRis0QklBcld3ZG1SVHVsRi9WOFJGNnNHRmJKbUlTb3FEVzBWZUxjejI5aWVYWjZ4cDlVYlYKazczemhSMER5WG51bFJ2TE81bEFBbW8xdGZlcStZZWl4V21uVjh0K0M0OTlkU3JGK3owTGxldndNYzRSZ3BUQgpJYkUzT1YxUmd4cUZNcENJQnBDc0pUTnovVmg3bTYvMnJjT0twMVBmMXJKd0psbDZPaHdxNVpsbmlKQ0x1cm1ICkhjMVd3U1NobTlZMk14VUhTUENIeEc5WWRiT05VcEJ5RVFJOGVwSFY5elRCRHhONVVpZ1N5c1lLQ3hIelhoMUcKZlNCY3Bsbi8rb2Ezb1BMZ3pyazRNTDFRdkxscWordngxTk9GTVF0Z0dYWHpVdUZMQUlTbjd6UFQ3aTNKSHNaZwozdzAyMno0OWExcU9lQWpxbmo5Q0MzWFc2d1BGcmdLRjVLQ3ZoRU9aWW4zNzFHRUhPRDFSWHAyNEdKSnBDQmZkCmpqN05uZDNWNTdRdjVuOVh4MGxsWDhlR1RtZFU1MFBscmw3SEplcStySEI1d3BZSTFVVHNpUERCMjUrYmh5UEUKcTB1RXJBRDNoU2dqVU15em5FeGVnQk85VVNPaENlTTZiR0FZbmJVTjl4T1NMMWN0MGc9PQo9SXRLZQotLS0tLUVORCBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0t'
							>this PGP key.</a></strong>
					</p>
				</div>
			</div>
		</div>

		<script src='websign/js/crypto.js'></script>
		<script src='websign/js/keys.js'></script>
		<script src='websign/lib/supersphincs.js'></script>
		<script src='websign/lib/fetch.js'></script>

		<script>(function () {


		if (location.host.indexOf('www.') === 0) {
			location.host	= location.host.replace('www.', '');
		}
		else if (
			location.host === '$PROJECT' &&
			LocalStorage.isPersistent &&
			!LocalStorage.webSignWWWPinned
		) {
			LocalStorage.webSignWWWPinned	= true;
			location.host					= 'www.' + location.host;
		}


		var WebSign	= {
			bootstrapText: '',

			cdnUrl: '',

			isOnion: location.host.split('.').slice(-1)[0] === 'onion',

			config: {
				abortText: 'Loading Cyph failed. Please try again later.',
				cdnUrlBase: '.cdn.cyph.com/websign/',
				continentUrl: 'https://api.cyph.com/continent',
				defaultContinent: 'eu',
				signaturePath: '$PROJECT.pkg.sig',
				packagePath: '$PROJECT.pkg',

				files: [
					'./',
					'websign/js/workerhelper.js',
					'websign/appcache.appcache',
					'websign/manifest.json',
					'serviceworker.js',
					'unsupportedbrowser'
				],

				publicKeys: PUBLIC_KEYS
			}
		};

		if (WebSign.isOnion) {
			WebSign.config.cdnUrlBase		= 'cdn.cyphdbyhiddenbhs.onion/websign/';
			WebSign.config.defaultContinent	= '';
		}

		try {
			navigator.serviceWorker.
				register('serviceworker.js').
				catch(function () {})
			;
		}
		catch (_) {}


		/* Hash WebSign bootstrap for a self-administered integrity check */
		Promise.all(
			WebSign.config.files.map(function (file) {
				return fetch(file).then(function (response) {
					return response.text();
				});
			})
		).then(function (results) {
			WebSign.bootstrapText	= WebSign.config.files.
				map(function (file, i) {
					return file + ':\n\n' + results[i] + '\n\n\n\n\n\n';
				}).
				join('')
			;

			return superSphincs.hash(WebSign.bootstrapText);
		}).then(function (hash) {
			LocalStorage.webSignHashOld	= LocalStorage.webSignHash;
			LocalStorage.webSignHash	= hash.hex;
		}).

		/* Get user's current location to choose optimal CDN node */
		then(function () {
			if (!WebSign.isOnion) {
				return fetch(WebSign.config.continentUrl);
			}
		}).then(function (response) {
			if (response) {
				return response.text();
			}
		}).

		/* Get latest signature data from CDN, with fallback logic
			in case node for current continent is offline */
		then(function (continent) {
			function getSignature (newContinent) {
				WebSign.cdnUrl		=
					'https://' +
					newContinent +
					WebSign.config.cdnUrlBase
				;

				return new Promise((resolve, reject) {
					setTimeout(reject, 10000);

					fetch(
						WebSign.cdnUrl + WebSign.config.signaturePath + '?' + Date.now()
					).then(function (response) {
						resolve(response.text());
					});
				});
			}

			if (continent) {
				return getSignature(continent).catch(function () {
					return getSignature(WebSign.config.defaultContinent);
				});
			}
			else {
				return getSignature(WebSign.config.defaultContinent);
			}
		}).

		/* Process signature data */
		then(function (s) {
			var signatureLines	= s.split('\n');

			var signatureData	= {
				signature: signatureLines[0],
				rsaKey: WebSign.config.publicKeys.rsa[parseInt(signatureLines[1], 10)],
				sphincsKey: WebSign.config.publicKeys.sphincs[parseInt(signatureLines[2], 10)],
				timestamp: parseInt(signatureLines[3], 10)
			};

			var packageUrl		=
				WebSign.cdnUrl + WebSign.config.packagePath + '?' + signatureData.timestamp
			;

			return Promise.all([
				signatureData,
				packageUrl,
				superSphincs.importKeys({
					public: {
						rsa: signatureData.rsaKey,
						sphincs: signatureData.sphincsKey
					}
				}),
				fetch(packageUrl).then(function (response) {
					return response.text();
				})
			]);
		}).catch(function () {
			return [
				{
					signature: null,
					rsaKey: null,
					sphincsKey: null,
					timestamp: 0
				},
				'',
				{},
				'{}\n'
			];
		}).

		/* Validate signature */
		then(function (results) {
			var signatureData	= results[0];
			var packageUrl		= results[1];
			var publicKey		= results[2].publicKey;
			var signed			= parseSigned(results[3]);

			/* Fall back to previous known good version if this one
				is older or has invalid metadata */
			if (
				!signatureData.rsaKey ||
				!signatureData.sphincsKey ||
				signed.metadata.timestamp !== signatureData.timestamp ||
				Date.now() > signed.metadata.expires ||
				parseInt(LocalStorage.webSignTimestamp, 10) > signed.metadata.timestamp
			) {
				throw 'Invalid data.';
			}

			return Promise.all([
				signed.metadata,
				packageUrl,
				superSphincs.verifyDetached(
					signatureData.signature,
					signed.complete,
					publicKey,
					true
				))
			]);
		}).then(function (results) {
			var metadata	= results[0];
			var packageUrl	= results[1];
			var isValid		= results[2].isValid;
			var hash		= results[2].hash;

			if (!isValid) {
				throw 'Invalid signature.';
			}

			LocalStorage.webSignExpires			= metadata.expires;
			LocalStorage.webSignHashWhitelist	= JSON.stringify(metadata.hashWhitelist);
			LocalStorage.webSignTimestamp		= metadata.timestamp;
			LocalStorage.webSignPackageUrl		= packageUrl;
			LocalStorage.webSignPackageHash		= hash;

			return package;
		}).

		/* Invalid signature; attempt to grab previous
			known good package from cache */
		catch(function () {
			if (
				!LocalStorage.webSignPackageUrl ||
				!LocalStorage.webSignPackageHash ||
				Date.now() > parseInt(LocalStorage.webSignExpires, 10)
			) {
				throw 'No fallback version.';
			}

			return new Promise((resolve, reject) {
				setTimeout(reject, 3000);

				fetch(LocalStorage.webSignPackageUrl).then(function (response) {
					resolve(response.text());
				});
			}).then(function (s) {
				var signed	= parseSigned(s);

				return Promise.all([
					signed.package,
					superSphincs.hash(signed.complete)
				]);
			}).then(function (results) {
				var package	= results[0];
				var hash	= results[1].hex;

				if (hash !== LocalStorage.webSignPackageHash) {
					throw 'Fallback hash mismatch.';
				}

				return package;
			});
		}).

		/* Successfully execute package */
		then(function (package) {
			if (!validateBootstrap()) {
				return;
			}

			try {
				document.open('text/html');
				document.write(package);
				document.close();
			}
			catch (_) {}
		}).

		/* Abort */
		catch(function () {
			if (!validateBootstrap()) {
				return;
			}

			var preLoad			= document.getElementById('pre-load');
			var preLoadMessage	= document.getElementById('pre-load-message');

			while (true) {
				var child	= preLoad.children[0];

				if (child === preLoadMessage) {
					break;
				}
				else {
					preLoad.removeChild(child);
				}
			}

			preLoadMessage.innerText	= WebSign.config.abortText;
		});


		function parseSigned (s) {
			var divider	= s.indexOf('\n');

			return {
				complete: s,
				metadata: JSON.parse(s.slice(0, divider)),
				package: s.slice(divider + 1)
			};
		}

		function validateBootstrap () {
			try {
				var hashWhitelist	= JSON.parse(LocalStorage.webSignHashWhitelist);

				if (hashWhitelist[LocalStorage.webSignHash]) {
					return true;
				}
			}
			catch (_) {
				return true;
			}

			var preLoad			= document.getElementById('pre-load');
			var panicMessage	= document.getElementById('panic-message');

			while (true) {
				var child	= preLoad.children[0];

				if (child === panicMessage) {
					break;
				}
				else {
					preLoad.removeChild(child);
				}
			}

			panicMessage.style.display	= 'block';

			/* Also try to warn us, though in a serious attack this may be blocked */
			fetch('https://mandrillapp.com/api/1.0/messages/send.json', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					key: 'HNz4JExN1MtpKz8uP2RD1Q',
					message: {
						from_email: 'test@mandrillapp.com',
						to: [{
							email: 'errors@cyph.com',
							type: 'to'
						}],
						autotext: 'true',
						subject: 'CYPH: SOMEONE JUST GOT THE WEBSIGN ERROR SCREEN LADS',
						text:
							navigator.language + '\n\n' +
							navigator.userAgent + '\n\n' +
							location.toString().replace(/\/#.*/g, '') + '\n\n' +
							'\n\ncdn url: ' + WebSign.cdnUrl +
							'\n\ncurrent bootstrap hash: ' + LocalStorage.webSignHash +
							'\n\nprevious bootstrap hash: ' + LocalStorage.webSignHashOld +
							'\n\npackage hash: ' + LocalStorage.webSignPackageHash +
							'\n\n\n\n' + WebSign.bootstrapText
					}
				})
			});

			return false;
		}


		}());</script>
	</body>
</html>
